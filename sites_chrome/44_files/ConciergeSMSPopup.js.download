/* 여행 톡집사 관련 SMS 팝업 공통 스크립트 */

///// jquery 는 import 선행 
if (typeof ($j) == "undefined") {
    loadScript(location.protocol + "//tour.interpark.com/Scripts/jquery-1.10.2.min.js", initTravelTalk)
}
else {
    initTravelTalk();
}


function loadExternalHtml() {
    
    var $load_content = null;
    var $btnClose = null;
    var $btnOpen = null;
    var $background = null;
    
    if ($j('#loading').length == 0) {
        $background = $j('<div class="custom_background" >');
        $background.css({ position: "fixed", top: 0, left: 0, width: "100%", height: $j(window).height(), background: "rgba(0, 0, 0, 0.5)", 'z-index': "200", display: "none", "text-align": "center" });
        $background.bind('click', function () { hideConciergeSMS(); });

        $load_content = $j('<iframe frameBorder="0" onload="postUrl()" style="overflow:hidden;width: 620px;height: 840px;display:none;z-index:201" id="loading" src="' + location.protocol + '//tour.interpark.com/iframe/ConciergeSMSPopup" />')
        $btnClose = $j('<input id="btnClose" type="button" style="display:none"  value="close" />')
        $btnOpen = $j('<input id="btnopen" type="button" style="display:none" value="open" />')

        $background.append($load_content);

        $j('body').append($background);
        $j('body').append($btnClose);
        $j('body').append($btnOpen);


        $j('#btnClose').bind('click', function (e) {
            hideConciergeSMS();
        });

        $j('#btnopen').bind('click', function (e) {
            showConciergeSMS();
        });


    }
}

function showConciergeSMS() {
    if ($j('.custom_background').length > 0) {
        $j('.custom_background').css('display','block');
    }

    if ($j('#loading').length > 0) {
        $j('#loading').css('display','block');
        $j('#loading').css({
            "top": ($j(window).height() - $j('#loading').height()) / 2 + "px",
            "position": "relative",
            "margin":"auto"
        });
    }
}

// link - 톡집사 전 url
// type - 톡집사 후 진입 타입 (톡집사진입 : A, 톡집사 예약진입 : R , 톡집사바로진입 : D)
function GoLinkOrTravelTalk(link, type, obj) {

    if (true) {
        //showConciergeSMS()
        switch (type) {
            case "A": 
                TalkEnterModule.Start();
                break;
            case "R": 
                if (!obj.ReservationNo) {
                    TalkEnterModule.Start();
                }
                else {
                    TalkEnterModule.ReservationStart(obj.ReservationNo, obj.SystemType);
                }
                break;
            case "D": 
                TalkEnterModule.DirectStart()
                break;
            case "P":
                // 상세페이지 톡집사연결
                // 온박사용 동일 프로세스 사용
                TalkEnterModule.OAStart(obj.Message, obj.oa_keyword, obj.oa_account)
                break;
            default:
                TalkEnterModule.Start();
                break;
        }
    }
    else{
        location.href = link;
    }
    

}
function hideConciergeSMS() {
    if($j('#loading').length != 0) 
        $j('#loading').css('display','none');

    if ($j('.custom_background').length > 0)
        $j('.custom_background').css('display', 'none');
}

function loadScript(url, callback) {

    var script = document.createElement("script")
    script.type = "text/javascript";

    if (script.readyState) {  //IE
        script.onreadystatechange = function () {
            if (script.readyState == "loaded" ||
                    script.readyState == "complete") {
                script.onreadystatechange = null;
                callback();
            }
        };
    } else {  //Others
        script.onload = function () {
            callback();
        };
    }

    script.src = url;
    document.getElementsByTagName("head")[0].appendChild(script);
}

function initTravelTalk() {
    // jquery alias 충돌 방지 ($ != jQuery 경우 원형유지)
    if ($j == $)
    {
        $j = $j || $
    }

    $j(document).ready(function () {
        loadExternalHtml();
    })
}

function postUrl() {
    var receiver = document.getElementById('loading').contentWindow;
    var message = JSON.stringify({ m: location.protocol + "//" + location.host })
    receiver.postMessage(message, location.protocol + "//tour.interpark.com");
}

function receiveMessage(event) {
    
    if (event.origin !== location.protocol + "//tour.interpark.com")
        return;
    else
        hideConciergeSMS();

}

if (window.addEventListener) {
    window.addEventListener("message", receiveMessage, false);
}
else {
    window.attachEvent("onmessage", receiveMessage);
}

