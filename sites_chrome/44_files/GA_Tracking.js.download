
var loc = window.document.location.href.toLowerCase();
function fnGA_GetCategoryForCD18() {
    var cate = "공통";

    if (loc.indexOf("tourexpo.interpark.com") > -1 || loc.indexOf("tourexpoevent.interpark.com") > -1) {
        cate = "온라인박람회";
    }
    else if (loc.indexOf("/airticket/") > -1) {
        cate = "해외항공"
        if (loc.indexOf("/domestic/") > -1) {
            cate = "국내항공"
        }
    }
    else if (loc.indexOf("/package/") > -1 || loc.indexOf("/free/") > -1 || loc.indexOf("/mall/") > -1 || loc.indexOf("/malle/") > -1 || loc.indexOf("/resort/") > -1 || loc.indexOf("/tourarea/") > -1 || loc.indexOf("/themetour/") > -1) {
        cate = "해외여행";
    }
    else if (loc.indexOf("/domestic/") > -1 || loc.indexOf("/jeju/") > -1 || loc.indexOf("/rentcar/") > -1) {
        cate = "국내여행";
    }
    else if (loc.indexOf("/airtel/") > -1) {
        cate = "항공+호텔";
    }
    else if (loc.indexOf("/hotel/") > -1) {
        cate = "해외호텔";
    }
    else if (loc.indexOf("/housing/") > -1) {
        cate = "국내숙박";
    }
    return cate;
}
function ConvertGradeCDToNM(grdCD) {
    var grdNM = '';
    if (grdCD == '01' || grdCD == '1') { grdNM = 'welcome'; }
    else if (grdCD == '11') { grdNM = 'family'; }
    else if (grdCD == '12') { grdNM = 'vip'; }
    else if (grdCD == '13') { grdNM = 'vvip'; }
    return grdNM
}
// 전자상거래 GA Tracking 용, 전역변수 DataLayer 추가 
var dataLayer = [{
    'uid': getCookie('tempinterparkGUEST'),                             //getCookie('interparkID')
    'CD1': getCookie('tempinterparkGUEST'),                             //getCookie('interparkID')
    'CD2': typeof getCookie('IEGS_GUIF').split('$')[1] != "undefined" && getCookie('IEGS_GUIF').split('$')[1] != "" ? getCookie('IEGS_GUIF').split('$')[1] : "3",
    'CD3': typeof getCookie('IEGS_GUIF').split('$')[2] != "undefined" ? ("OA" + getCookie('IEGS_GUIF').split('$')[2] + "P") : "",
    'CD5': ConvertGradeCDToNM(getCookie('IEGS_GUIF').split('$')[0]),
}];


// PC여행 : GTM-5H6993, PC국내항공 : GTM-PV7DRG, 온라인박람회 : GTM-WWMGLQ
var GTM_Part_Key = (loc.indexOf("tourexpo.interpark.com") > -1 || loc.indexOf("tourexpoevent.interpark.com") > -1) ? 'GTM-WWMGLQ' : ((location.pathname.indexOf('/airticket/') != -1) ? 'GTM-PV7DRG' : 'GTM-5H6993');

// GA TOUR 추가 작업
(function (w, d, s, l, i) {
    w[l] = w[l] || []; w[l].push({
        'gtm.start':
        new Date().getTime(), event: 'gtm.js'
    }); var f = d.getElementsByTagName(s)[0],
    j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
})(window, document, 'script', 'dataLayer', GTM_Part_Key);

//(function (i, s, o, g, r, a, m) {
//    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
//        (i[r].q = i[r].q || []).push(arguments)
//    }, i[r].l = 1 * new Date(); a = s.createElement(o),
//    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
//})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');


//try {
//    ga('create', 'UA-86011220-1', 'auto');
//    ga('send', 'pageview');
//} catch (e) { }


var tourDomain = "tour.interpark.com";
if (!(loc.indexOf(tourDomain + "/goods/detail") > -1 || loc.indexOf(tourDomain + "/reservation/orderlist") > -1 || loc.indexOf(tourDomain + "/reservation/order") > -1)) {
    fnGA_AddPageDepth(null);
}

function fnGA_AddPageDepth(MiddleCateCD) {
    try {
        var MiddleCateNM = "공통";
        if (MiddleCateCD == null) {
            MiddleCateNM = fnGA_GetCategoryForCD18();
        }
        else {
            if (MiddleCateCD == "AA") {
                MiddleCateNM = "국내여행";
            }
            else {
                MiddleCateNM = "해외여행";
            }
        }
        dataLayer.push({
            'event': 'addPageDepth',
            'CD17': '투어',                            //대카테고리 구분 : 투어
            'CD18': MiddleCateNM,                            //중카테고리 구분 : 해외여행 / 국내여행
            'CD19': fnGA_GetDeviceInfo(),                            //**디바이스 구분 : PC_Web // Mobile_Web // 인터파크투어 앱 // 체크인나우 앱 // 항공 앱 // 해외호텔 앱...
        });
    } catch (e) { }
}
//2017.06 GA RENEW
function fnGA_GetDeviceInfo() {
    var mobileRegEx = new RegExp(/iPhone|iPod|iPad|Mobile|UP.Browser|Android|BlackBerry|Windows CE|Nokia|webOS|Opera Mini|SonyEricsson|Opera Mobi|Windows Phone|IEMobile|POLARIS|SKT|LG|LGPlayer|Bada|Kindle|Wii/ig);
    var _agent = navigator.userAgent.toLowerCase();
    var isApp = (_agent.indexOf("mobile_app") > -1) ? true : _agent.indexOf("interparkbrowser-shop") > -1 ? true : false;
    var isMobile = navigator.userAgent.toLowerCase().match(mobileRegEx);

    var result;
    if (!isApp && !isMobile) {
        result = "PC_Web";
    }
    else if (!isApp && isMobile) {
        result = "Mobile_Web";
    }
    else if (isApp) {
        result = (_agent.indexOf("interparkbrowser-shop") > -1 ? "인터파크통합앱" : _agent.indexOf("interparktourair") > -1 ? "항공 앱" : (_agent.indexOf("interparktourabroadhotel") > -1 ? "해외호텔 앱" : (_agent.indexOf("interparktourcheckinnow") > -1 ? "체크인나우 앱" : "인터파크투어 앱")));
    }
    return result;
    //PC_Web // Mobile_Web // 인터파크투어 앱 // 체크인나우 앱 // 항공 앱// 해외호텔 앱

}
function fnGA_CheckoutOption(checkType, step, option) {
    try {
        var eventName;
        if (checkType == 'R')//Reservation
        {
            eventName = 'checkoutOption';
        }
        else if (checkType == 'P')//Pay
        {
            eventName = 'pay_checkoutOption';
        }
        else {
            return false;
        }

        dataLayer.push({
            'event': eventName,
            'ecommerce': {
                'checkout_option': {
                    'actionField': {
                        'step': step,                  //단계별 번호(1~7)
                        'option': option               //결제수단 정보 step 마지막 단계 삽입
                    }
                }
            }
        });
    } catch (e) { }
}
function fnGA_TourDetail(tourDetailInfo) {
    try {


        var p = tourDetailInfo;
        var goodsType = p.GoodsType;
        if (goodsType == "")
            return false;

        var MiddleCategory = p.AreaCD;
        if (MiddleCategory == 'AA')
            MiddleCategory = "국내여행";
        else
            MiddleCategory = "해외여행";

        dataLayer[0].CD18 = MiddleCategory;
        dataLayer[0].Depth1 = MiddleCategory;

        dataLayer.push({
            'event': 'detail',
            'ecommerce': {
                'detail': {
                    'products': [{
                        'id': p.Id,                                              //상품코드 : 출발상품코드
                        'name': p.Name,                                          //상품명
                        'price': p.Price,                                        //상품금액 (쉼표생략)
                        'brand': p.Brand,                                        //상품타입 : 항공사명 (국내는 제주도행 항공사명, 그외 빈값)
                        'category': MiddleCategory + '/' + p.GoodsTypeNM + '/' + p.AreaKRNM + '/' + p.CoutryNM + '/' + p.CityNM,            //대분류/중분류/지역/국가/도시
                        'variant': p.PCateNM + '_' + p.CateNM,                    //상세구분 : 홈쇼핑 / 허니문 / 부산출발 / 전문몰지역명
                        'quantity': 1,//Number(p.AdultCnt) + Number(p.InfantCnt) + Number(p.BabyCnt),                       //탑승객 인원수 (숫자만표기) : 성인,소아,유아 SUM값
                        'dimension1': getCookie('tempinterparkGUEST'),                 //getCookie('interparkID')
                        'dimension2': '',                                       //성별 (남:10, 여:20) (로그인하지않으면 공백)
                        'dimension3': '',                                       //연령 (0A나이P) (로그인하지않으면 공백)
                        'dimension5': '',                                       //등급 : 다이아몬드 (로그인하지않으면 공백)
                        'dimension14': p.BaseGoodsCD,                            //카테고리코드 : 기초상품코드
                        'dimension17': '투어',                                   //대카테고리 구분 : 투어
                        'dimension18': MiddleCategory,                           //중카테고리 구분 : 해외여행 / 국내여행
                        'dimension19': fnGA_GetDeviceInfo(),                     //디바이스 구분 : PC_Web // Mobile_Web // 인터파크투어 앱 // 체크인나우 앱 // 항공 앱 // 해외호텔 앱...
                        'dimension20': p.GoodsTypeNM,                              //소카테고리 구분 : 패키지 // 자유여행 // 해외티켓 // 내륙테마 // 제주여행만들기...
                        'position': p.Position//출발지
                    }]
                }
            }
        });
    } catch (e) { }
}

function fnGA_TourOrderConfirm(tourConfirmInfo) {
    try {


        var p = tourConfirmInfo;
        var goodsType = p.GoodsType;
        if (goodsType == "")
            return false;

        dataLayer[0].CD18 = p.AreaCD == "AA" ? "국내여행" : "해외여행";
        dataLayer[0].Depth1 = p.AreaCD == "AA" ? "국내여행" : "해외여행";
        var leadTime = '';
        if (p.NowDate.length > 7 && p.StartDate.length > 7) {
            var oneDay = 24 * 60 * 60 * 1000;
            var d1 = new Date(p.StartDate.substr(0, 4), p.StartDate.substr(4, 2), p.StartDate.substr(6, 2))
            var d2 = new Date(p.NowDate.substr(0, 4), p.NowDate.substr(4, 2), p.NowDate.substr(6, 2))
            leadTime = Math.round(Math.abs((d1.getTime() - d2.getTime()) / (oneDay)));
        }
        

        dataLayer.push({
            'event': 'transaction',
            'metric1': p.IpointPayAmt,
            'metric2': p.CouponDCAmt,
            'metric3': 0,
            'metric4': 0,
            'metric7': p.SaleTotAmt,
            'purchaseId': p.ResNo,
            'ecommerce': {
                'purchase': {
                    'actionField': {
                        'id': p.ResNo,
                        'affiliation': getCookie("ippcd"),
                        'revenue': p.SaleTotAmt,
                        'tax': 0,
                        'coupon': p.CouponDetail
                    },
                    'products': [{
                        'id': p.GoodsCD,
                        'name': p.ProductName,
                        'price': p.SaleTotAmt,
                        'brand': p.Brand,
                        'category': (p.AreaCD == "AA" ? "국내여행" : "해외여행" ) + '/' + p.GoodsTypeNM + '/' + p.AreaKRNM + '/' + p.CoutryNM + '/' + p.CityNM,
                        'variant': p.GoodsTypeNM,
                        'quantity': 1,
                        'dimension1': getCookie('tempinterparkGUEST'),
                        'dimension2': '',
                        'dimension3': '',
                        'dimension5': '',
                        'dimension6': p.StartDate,
                        'dimension7': p.EndDate,
                        'dimension8': p.DayCnt,
                        'dimension9': 1,//Number(p.AdultCnt) + Number(p.InfantCnt) + Number(p.BabyCnt) + '(성인' + p.AdultCnt + ', 소아' + p.InfantCnt + ', 유아' + p.BabyCnt + ')',
                        'dimension10': p.NightCnt,
                        'dimension11': p.TrafficRetTripNM,
                        'dimension12': p.NowDate,
                        'dimension13': p.StartDateMonth,
                        'dimension14': p.BaseGoodsCD,
                        'dimension15': leadTime,
                        'dimension16': p.ProcessStatus,
                        'dimension17': '투어',
                        'dimension18': p.AreaCD == "AA" ? "국내여행" : "해외여행",
                        'dimension19': fnGA_GetDeviceInfo(),
                        'dimension20': p.GoodsTypeNM,
                        'metric5'    : p.DayCnt,
                        'metric6'    : p.NightCnt,
                        'position'   : p.Position//출발지
                    }]
                }
            }
        });
    } catch (e) { };
}
function fnGA_LoginResult(resultcode, isSNSlogin) {
    try {
        if (isSNSlogin) {
            resultcode = '000'
        }
        dataLayer.push({ 'event': 'loginResult', 'gtm_login_loginResultCode': resultcode, 'gtm_login_isSNSlogin': isSNSlogin });
    } catch (e) { }
}

function getCookie(name) {
    var nameOfCookie = name + "=";
    var x = 0;
    while (x <= document.cookie.length) {
        var y = (x + nameOfCookie.length);
        if (document.cookie.substring(x, y) == nameOfCookie) {
            if ((endOfCookie = document.cookie.indexOf(";", y)) == -1)
                endOfCookie = document.cookie.length;
            return unescape(document.cookie.substring(y, endOfCookie));
        }
        x = document.cookie.indexOf(" ", x) + 1;
        if (x == 0)
            break;
    }
    return "";
}

function fnGA_Search(keyword, id, category, position, dimension1, dimension5, dimension6, dimention17, dimension18)
{
    dataLayer.push({
        "event": "search",
        "tour_SearchKW": keyword,               //검색어
        "id": id,           //검색결과 id 나열
        "category": category,
        "position": position,       //출발지,
        "dimension1": dimension1,  //고객키값(UID)
        "dimension5": dimension5,                 //회원등급
        "dimension6": dimension6,            //"출발일자 (YYYY-MM-DD)
        "dimension17": dimention17,
        "dimension18": dimension18                        //국내여행 or 해외여행
    })
}
