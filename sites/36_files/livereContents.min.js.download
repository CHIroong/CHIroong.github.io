function Utils() {}
var lvTemplate = {
    list: '<ul class="contents-list contents-list0"> {{#list0}} <li tabindex="0" data-title="{{{escapeTag itemName}}}" data-url="{{itemUrl}}" data-refer="{{itemId}}" data-image="{{itemImage}}"> <span class="article-title">{{{escapeTag itemName}}}</span>{{counter}}</li> {{/list0}} </ul> <ul class="contents-list contents-list1"> {{#list1}} <li tabindex="0" data-title="{{{escapeTag itemName}}}" data-url="{{itemUrl}}" data-refer="{{itemId}}" data-image="{{itemImage}}"> <span class="article-title">{{{escapeTag itemName}}}</span>{{counter}}</li> {{/list1}} </ul>',
    reply: '<a href="{{addRccode itemUrl type}}" title="{{{escapeTag itemName}}}.. 페이지로 이동" target="_top"><div class="lv-sm"> <div class="lv-sm-thumnail" > <img src="{{thumcheck itemImage}}" alt="thumnial image"> </div> <div class="lv-sm-info"> <span class="lv-sm-title">{{{escapeTag itemName}}}</span> <span class="lv-sm-link">{{cutting itemUrl}}</span></div><div class="lv-sm-ad"><ins class="adsbygoogle" style="display:inline-block;width:468px;height:15px" data-language="ko" data-ad-client="{{gdn_client}}" data-ad-slot="{{gdn_slot}}"></ins></div></div></a> <div class="lv-replys"> <ol> {{#each replys}} <li><span class="user-domain {{member_domain}}">{{member_domain}}</span> <a href="{{addRccode ../itemUrl ../type}}" title="{{../itemName}}.. 페이지로 이동" target="_top">{{delBr content}}</a></li> {{/each}} </ol> </div>',
    noreply: '<a href="{{addRccode itemUrl type}}" title="{{{escapeTag itemName}}}.. 페이지로 이동" target="_top"><div class="lv-sm"> <div class="lv-sm-thumnail" > <img src="{{thumcheck itemImage}}" alt="thumnial image"> </div> <div class="lv-sm-info"> <span class="lv-sm-title">{{{escapeTag itemName}}}</span> <span class="lv-sm-link">{{cutting itemUrl}}</span></div><div class="lv-sm-ad"><ins class="adsbygoogle" style="display:inline-block;width:468px;height:15px" data-language="ko" data-ad-client="{{gdn_client}}" data-ad-slot="{{gdn_slot}}"></ins></div></div></a> <div class="no-replys"><p><img src="https://cdn-city.livere.com/liveContents/t/img/comment_zero_icon_@3x.png" alt="">첫 댓글을 작성해주세요.</p></div>',
    tenping : {
        title : '<li class="tenping-title"> \
                    <a href="{{Link}}" title="[AD] {{ContentTitle}}" target="_blank"> \
                        <span> [AD] {{ContentTitle}}</span> \
                    </a> \
                </li>',
        body : ''
    },
    lvHelper: function() {
        Handlebars.registerHelper("cntSize", function(e) {
            return e > 99 ? "99+" : e
        }), Handlebars.registerHelper("cutting", function(e) {
            return e.replace("//", "").replace("http:", "").replace("&rccode=lvRc", "").replace("?rccode=lvRc", "")
        }), Handlebars.registerHelper("thumcheck", function(e) {
            return "" === e ? "https://cdn-city.livere.com/liveContents/t/img/thumbnail_icon.png" : e
        }), Handlebars.registerHelper("escapeTag", function(e) {
            var t = e.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            return new Handlebars.SafeString(t)
        }), Handlebars.registerHelper("delBr", function(e, t) {
            return e.replace(/<br \/>/g, " ")
        }), Handlebars.registerHelper("addRccode", function(e, t) {
            var i = t && "s" === t ? "https://" : "http://";
            e = e.replace("http://", "").replace("https://", "");
            var a = utils.addRccode(e);
            return i + a
        }), Handlebars.registerHelper("counter", function() {
            var e = this.replyCount;
            return e <= 0 ? "" : (e = e > 99 ? "99+" : e, new Handlebars.SafeString('<span class="reply-count">' + e + "</span>"))
        })
    }
};
Utils.prototype.isMobile = function() {
    var e = new Array("iphone", "ipod", "blackberry", "android", "windows ce", "lg", "mot", "samsung", "sonyericsson", "iemobile"),
        t = new Array("ipad", "shw-m180s", "shw-m380k", "shw-m480k", "sm-p600"),
        i = !1;
    return $(e).each(function(e, t) {
        var a = navigator.userAgent.toLowerCase();
        if (null !== a.match(t)) return i = !0, !1
    }), i && $(t).each(function(e, t) {
        var a = navigator.userAgent.toLowerCase();
        if (null !== a.match(t)) return i = !1, !1
    }), i
}, Utils.prototype.compile = function(e, t) {
    var i = Handlebars.compile(e);
    return i(t)
}, Utils.prototype.getParam = function(e) {
    e = e.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var t = new RegExp("[\\?&]" + e + "=([^&#]*)"),
        i = t.exec(location.search);
    return null === i ? "" : decodeURIComponent(i[1].replace(/\+/g, " "))
}, Utils.prototype.addRccode = function(e) {
    var t = "&rccode=lvRc",
        i = "?rccode=lvRc",
        a = document.createElement("a");
    return a.href = e, "" === a.search ? e + i : e + t
};
var utils = new Utils;
$(window).ready(function() {
    liveContents.init()
});
var lvLogger = {
    settings: {
        livere_seq: utils.getParam("ls"),
        consumer_seq: utils.getParam("cs"),
        cuid: utils.getParam("cuid"),
        clientName: utils.getParam("cName"),
        refer: utils.getParam("refer"),
        type: utils.getParam("type"),
        ver: utils.getParam("ver"),
        gdn: "true" == utils.getParam("gdn"),
        gdn_client: "ca-pub-9319698996485234",
        gdn_slot: "9491099106",
        pcid: utils.getParam("pcid") || "",
        tenping: (utils.getParam('tenping') == 'true')
    }
},
liveContents = function(e, t) {
    "use strict";
    var i = {};
    return i.init = function() {
        lvTemplate.lvHelper(), i.api.helpPopup(), i.api.getList()
    }, i._props = {
        listApi: "https://rb-rec-api-livere.recobell.io/rec/a001",
        reply_basic: "https://dev.livere.co.kr/API_Livere?livereCallback=?&dummy=" + Math.random(),
        reply_city: "https://api-city.livere.com/API_Livere?livereCallback=?&dummy=" + Math.random(),
        countApi: "https://dev.livere.co.kr/API_Livere?command=getLiveBoxCount&dummy=0.05425893724896014&livereCallback=?",
        contentAdLogApi: 'http://1.201.139.168/lvcp',
        args: {
            format: "jsonp",
            size: "12",
            cuid: t.cuid,
            iids: encodeURI(t.refer),
            cpt: "m002",
            rnd: !0,
            pcid: t.pcid
        }
    }, i.tenpings = {
        init : function() {
            if (!lvLogger.settings.tenping) return;

            var params = {
                type: 'getTenpingData'
            };

            i.tenpings.recieveMessage();

            if (t.ver) {
                params = {e: 'setLiveContentsHeight', caller: 'liveContents', params: params};
            } 
        
            parent.postMessage(JSON.stringify(params), '*');
        },
        recieveMessage : function() {
            window.addEventListener('message', function (e) {
                var data = jQuery.parseJSON(e.data),
                    type = data.type ? data.type : 'default';
   
                switch (type) {
                    case 'default':
                        return;
                    case 'setLvContentTenpingData':
                        if (!data.adData || data.adData === 'null' || data.adData == 'undefined') return;

                        i.tenpings.getList(data);
                        break;
                }

            }, false);
        }, 
        getList : function(data) {
            var adData = data.adData, 
                cizionadData = data.cizionadData,
                targets = getAfterTargets(),
                paramUrl = i._props.contentAdLogApi + '?cs=' + lvLogger.settings.consumer_seq + '&ls=' + lvLogger.settings.livere_seq;

            $.each(adData, function(ii, vv) {
                var postBackUrl = paramUrl + '&cid=' + vv.ContentID + '&lvcid=' + vv.lvcid;
                vv.Link = vv.Link + '?p=' + encodeURIComponent(postBackUrl);
            });

            if (cizionadData) {
                var idx = Math.round(Math.random());
                adData[idx].ContentTitle = cizionadData.title;
                adData[idx].Link = cizionadData.shortUrl;
            }

            $.each(targets.origin, function(ii, vv) {
                var $target = $(vv),
                    $cloneTarget = $(targets.clone[ii]),
                    $html = $(utils.compile(lvTemplate.tenping.title, adData[ii]));

                if (ii >= adData.length) {
                	return false;
                }

                $target.after($html)
                       .remove();
                $cloneTarget.after($html.clone())
                            .remove();
            });

            function getAfterTargets() {
                var $list = $.merge($('.contents-list0'), $('.contents-list1')),
                    result = {
                        origin : [],
                        clone : []
                    };
                
                $.each($list, function(ii, vv) {
                    var $li = $(vv).children('li'),
                        length = $li.length,
                        pushTarget = null;

                    if ($(vv).attr('class').indexOf('bx-clone') > 0) {
                        pushTarget = result.clone;
                    } else {
                        pushTarget = result.origin;
                    }

                    pushTarget.push($li.eq((length / 2) - 1), $li.eq(length - 1));
                });

                return result;
            }
        }
    }, i.api = {
        helpPopup: function() {
            var t = e(".guide-popup"),
                i = e(".help-btn");
            i.hover(function() {
                t.fadeIn(100)
            }, function() {
                t.fadeOut(100)
            }), i.on("click", function() {
                t.toggle()
            })
        },
        getList: function() {
            e.ajax({
                type: "GET",
                url: i._props.listApi,
                data: i._props.args,
                dataType: "jsonp",
                success: function(t) {
                    var a = 0,
                        n = [];
                    e.each(t.results, function(e, t) {
                        a = parseInt(e / 6), n["list" + a] = n["list" + a] || [], n["list" + a].push(t.product)
                    }), e(".contents-list-container").html(utils.compile(lvTemplate.list, n)), i.api.listSlider(), i.api.replysBtnEvent(), i.tenpings.init();
                }
            })
        },
        listSlider: function() {
            var t = function() {
                var t = e(".bx-prev"),
                    i = e(".bx-next");
                e(".contents-prev-btn").on("click", function() {
                    t.trigger("click")
                }), e(".contents-next-btn").on("click", function() {
                    i.trigger("click")
                })
            };
            e(".contents-list-container").bxSlider({
                onSliderLoad: t
            })
        },
        replysBtnEvent: function() {
            function a() {
                n ? e(".contents-detail .lv-sm-ad").html(n) : ((adsbygoogle = window.adsbygoogle || []).push({}), setTimeout(function() {
                    n = e(".contents-detail .lv-sm-ad .adsbygoogle").clone()
                }, 100))
            }
            var n, l = e(".contents-list>li"),
                r = e(".go-list-btn");
            l.on("click", function() {
                var n = e(this),
                    l = t.ver ? i._props.reply_city : i._props.reply_basic,
                    r = {};
                r.calltype = "refer", r.command = "getArticle", r.sort = "good", r.livere_seq = t.livere_seq, r.consumer_seq = t.consumer_seq, r.refer = n.attr("data-refer"), r.viewpage = 1, r.rowsnum = 3;
                var s = {};
                s.itemUrl = n.attr("data-url"), s.itemName = n.attr("data-title"), s.itemImage = n.attr("data-image"), e.getJSON(l, r, function(i) {
                    s.replys = i.resultData, s.type = t.type, s.gdn_client = lvLogger.settings.gdn_client, s.gdn_slot = lvLogger.settings.gdn_slot, e(".contents-list-wrap, .list-btn-container").hide(), e(".contents-detail, .reply-btn-container").show(), null !== s.replys ? e(".contents-detail").html(utils.compile(lvTemplate.reply, s)) : e(".contents-detail").html(utils.compile(lvTemplate.noreply, s)), lvLogger.settings.gdn && a()
                })
            }).on("keypress", function(t) {
                13 === t.keyCode && e(this).trigger("click")
            }), r.on("click", function() {
                e(".contents-detail").empty(), e(".contents-list-wrap, .list-btn-container").show(), e(".contents-detail, .reply-btn-container").hide()
            })
        }
    }, {
        util: i.util,
        init: i.init
    }
}(jQuery, lvLogger.settings);
